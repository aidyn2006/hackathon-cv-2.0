<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–µ–∫—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - AI Detection System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>ü§ñ AI –î–µ—Ç–µ–∫—Ü–∏—è –î–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
                <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π, —à—Ç–∞–º–ø–æ–≤ –∏ QR-–∫–æ–¥–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º YOLO</p>
                <div class="badge-container">
                    <span class="badge badge-fast">‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º</span>
                    <span class="badge badge-ai">üß† AI-powered</span>
                </div>
            </div>
        </header>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".pdf" hidden>
                <div class="upload-content">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF –¥–æ–∫—É–º–µ–Ω—Ç</h3>
                    <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ <span class="link">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span></p>
                    <p class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: PDF ‚Ä¢ –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä: 16MB</p>
                </div>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="loading-animation">
                <div class="spinner"></div>
                <div class="loading-stages">
                    <p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="loading-hint">‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω</p>
                </div>
            </div>
        </div>

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="summary-stats" id="summaryStats" style="display: none;">
            <h2>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìÑ</div>
                    <div class="stat-value" id="totalPages">0</div>
                    <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="totalDetections">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úçÔ∏è</div>
                    <div class="stat-value" id="totalSignatures">0</div>
                    <div class="stat-label">–ü–æ–¥–ø–∏—Å–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè∑Ô∏è</div>
                    <div class="stat-value" id="totalStamps">0</div>
                    <div class="stat-label">–®—Ç–∞–º–ø–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì±</div>
                    <div class="stat-value" id="totalQR">0</div>
                    <div class="stat-label">QR-–∫–æ–¥–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="avgQuality">0%</div>
                    <div class="stat-label">–ö–∞—á–µ—Å—Ç–≤–æ</div>
                </div>
            </div>
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ—Ç–µ–∫—Ü–∏–∏</h2>
            <div id="resultsContainer"></div>
        </div>

        <div class="error" id="error" style="display: none;"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div class="modal" id="imageModal" style="display: none;">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">‚úï</button>
            <img id="modalImage" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const progressFill = document.getElementById('progressFill');
        const summaryStats = document.getElementById('summaryStats');
        const results = document.getElementById('results');
        const resultsContainer = document.getElementById('resultsContainer');
        const error = document.getElementById('error');

        let loadingProgress = 0;
        let loadingInterval;

        // –ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        uploadArea.addEventListener('click', () => fileInput.click());

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.includes('pdf')) {
                showError('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                showError('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            startLoading();

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                stopLoading();
                if (data.success) {
                    displayResults(data.results, data.summary);
                } else {
                    showError('‚ùå ' + (data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞'));
                }
            })
            .catch(err => {
                stopLoading();
                showError('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + err.message);
            });
        }

        function startLoading() {
            loading.style.display = 'block';
            results.style.display = 'none';
            summaryStats.style.display = 'none';
            error.style.display = 'none';
            
            loadingProgress = 0;
            const stages = [
                '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...',
                '–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...',
                '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞...',
                '–ó–∞–ø—É—Å–∫ YOLO –¥–µ—Ç–µ–∫—Ü–∏–∏...',
                '–ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...',
                '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è...'
            ];
            
            let stage = 0;
            loadingInterval = setInterval(() => {
                loadingProgress += Math.random() * 15;
                if (loadingProgress > 95) loadingProgress = 95;
                
                if (loadingProgress > stage * 15 && stage < stages.length) {
                    loadingText.textContent = stages[stage];
                    stage++;
                }
                
                progressFill.style.width = loadingProgress + '%';
            }, 500);
        }

        function stopLoading() {
            clearInterval(loadingInterval);
            loadingProgress = 100;
            progressFill.style.width = '100%';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 300);
        }

        function displayResults(data, summary) {
            resultsContainer.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (summary) {
                document.getElementById('totalPages').textContent = summary.total_pages || 0;
                document.getElementById('totalDetections').textContent = summary.total_detections || 0;
                
                // –ü–æ–¥—Å—á–µ—Ç –ø–æ —Ç–∏–ø–∞–º
                let signatures = 0, stamps = 0, qr = 0;
                data.forEach(page => {
                    page.yolo_detections.forEach(det => {
                        const className = det.class.toLowerCase();
                        if (className.includes('–ø–æ–¥–ø–∏—Å—å') || className.includes('signature')) {
                            signatures++;
                        } else if (className.includes('—à—Ç–∞–º–ø') || className.includes('stamp')) {
                            stamps++;
                        }
                    });
                    qr += page.qr_codes.length;
                });
                
                document.getElementById('totalSignatures').textContent = signatures;
                document.getElementById('totalStamps').textContent = stamps;
                document.getElementById('totalQR').textContent = qr;
                
                const quality = summary.average_quality || 0;
                document.getElementById('avgQuality').textContent = Math.round(quality * 100) + '%';
                
                summaryStats.style.display = 'block';
            }
            
            data.forEach((pageResult, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-result';
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const pageHeader = document.createElement('div');
                pageHeader.className = 'page-header';
                pageHeader.innerHTML = `
                    <h3>üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageResult.page}</h3>
                    <div class="page-stats-inline">
                        <span class="badge">üéØ ${pageResult.stats.total_detections} –æ–±—ä–µ–∫—Ç–æ–≤</span>
                        <span class="badge">üì± ${pageResult.stats.total_qr_codes} QR</span>
                        <span class="badge">‚≠ê ${Math.round(pageResult.quality_score * 100)}%</span>
                    </div>
                `;
                
                // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π side-by-side
                const imagesContainer = document.createElement('div');
                imagesContainer.className = 'images-container';
                imagesContainer.id = `images-${index}`;
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                const switcherDiv = document.createElement('div');
                switcherDiv.className = 'image-switcher';
                switcherDiv.innerHTML = `
                    <button class="switch-btn active" onclick="showImage(${index}, 'processed')">
                        üîç –° –¥–µ—Ç–µ–∫—Ü–∏—è–º–∏
                    </button>
                    <button class="switch-btn" onclick="showImage(${index}, 'original')">
                        üìÑ –û—Ä–∏–≥–∏–Ω–∞–ª
                    </button>
                `;
                
                // –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const processedDiv = document.createElement('div');
                processedDiv.className = 'image-box';
                processedDiv.id = `processed-${index}`;
                processedDiv.innerHTML = `
                    <img src="data:image/png;base64,${pageResult.image}" 
                         alt="–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageResult.page}"
                         onclick="openModal(this.src)">
                    <div class="image-overlay">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
                `;
                
                // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const originalDiv = document.createElement('div');
                originalDiv.className = 'image-box';
                originalDiv.id = `original-${index}`;
                originalDiv.style.display = 'none';
                originalDiv.innerHTML = `
                    <img src="data:image/png;base64,${pageResult.original_image}" 
                         alt="–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageResult.page}"
                         onclick="openModal(this.src)">
                    <div class="image-overlay">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
                `;
                
                imagesContainer.appendChild(switcherDiv);
                imagesContainer.appendChild(processedDiv);
                imagesContainer.appendChild(originalDiv);
                
                // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const statsDiv = document.createElement('div');
                statsDiv.className = 'detailed-stats';
                
                // YOLO –¥–µ—Ç–µ–∫—Ü–∏–∏
                const detectionsByClass = {};
                pageResult.yolo_detections.forEach(det => {
                    const className = det.class;
                    if (!detectionsByClass[className]) {
                        detectionsByClass[className] = [];
                    }
                    detectionsByClass[className].push(det);
                });
                
                let statsHTML = '<div class="stats-columns">';
                
                // –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - YOLO –¥–µ—Ç–µ–∫—Ü–∏–∏
                statsHTML += '<div class="stats-column">';
                statsHTML += '<h4>üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h4>';
                
                if (Object.keys(detectionsByClass).length > 0) {
                    Object.entries(detectionsByClass).forEach(([className, detections]) => {
                        const avgConf = (detections.reduce((sum, d) => sum + d.confidence, 0) / detections.length * 100).toFixed(1);
                        const icon = className.toLowerCase().includes('–ø–æ–¥–ø–∏—Å—å') || className.toLowerCase().includes('signature') 
                            ? '‚úçÔ∏è' 
                            : className.toLowerCase().includes('—à—Ç–∞–º–ø') || className.toLowerCase().includes('stamp')
                            ? 'üè∑Ô∏è'
                            : 'üì¶';
                        
                        statsHTML += `
                            <div class="detection-item">
                                <span class="detection-icon">${icon}</span>
                                <span class="detection-name">${className}</span>
                                <span class="detection-count">${detections.length}</span>
                                <span class="detection-conf">${avgConf}%</span>
                            </div>
                        `;
                    });
                } else {
                    statsHTML += '<p class="no-data">–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
                
                statsHTML += '</div>';
                
                // –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - QR-–∫–æ–¥—ã
                statsHTML += '<div class="stats-column">';
                statsHTML += '<h4>üì± QR-–∫–æ–¥—ã</h4>';
                
                if (pageResult.qr_codes.length > 0) {
                    pageResult.qr_codes.forEach((qr, idx) => {
                        const validIcon = qr.valid ? '‚úÖ' : '‚ö†Ô∏è';
                        const validClass = qr.valid ? 'valid' : 'invalid';
                        const data = qr.data.length > 50 ? qr.data.substring(0, 50) + '...' : qr.data;
                        
                        statsHTML += `
                            <div class="qr-item ${validClass}">
                                <span class="qr-icon">${validIcon}</span>
                                <div class="qr-data">
                                    <div class="qr-number">QR-–∫–æ–¥ #${idx + 1}</div>
                                    <div class="qr-content">${data}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    statsHTML += '<p class="no-data">QR-–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
                
                statsHTML += '</div>';
                statsHTML += '</div>';
                
                statsDiv.innerHTML = statsHTML;
                
                pageDiv.appendChild(pageHeader);
                pageDiv.appendChild(imagesContainer);
                pageDiv.appendChild(statsDiv);
                
                resultsContainer.appendChild(pageDiv);
            });
            
            results.style.display = 'block';
            
            // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            setTimeout(() => {
                summaryStats.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function showImage(pageIndex, type) {
            const processedDiv = document.getElementById(`processed-${pageIndex}`);
            const originalDiv = document.getElementById(`original-${pageIndex}`);
            const imagesContainer = document.getElementById(`images-${pageIndex}`);
            const buttons = imagesContainer.querySelectorAll('.switch-btn');
            
            if (type === 'processed') {
                processedDiv.style.display = 'block';
                originalDiv.style.display = 'none';
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                processedDiv.style.display = 'none';
                originalDiv.style.display = 'block';
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        }

        function openModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            setTimeout(() => {
                error.style.display = 'none';
            }, 5000);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
