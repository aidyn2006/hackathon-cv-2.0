<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–µ–∫—Ü–∏—è QR-–∫–æ–¥–æ–≤, –ø–æ–¥–ø–∏—Å–µ–π –∏ —à—Ç–∞–º–ø–æ–≤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç –î–µ—Ç–µ–∫—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è QR-–∫–æ–¥–æ–≤, –ø–æ–¥–ø–∏—Å–µ–π –∏ —à—Ç–∞–º–ø–æ–≤</p>
        </header>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".pdf" hidden>
                <div class="upload-content">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PDF —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ <span class="link">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span></p>
                    <p class="hint">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB</p>
                </div>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ—Ç–µ–∫—Ü–∏–∏</h2>
            <div id="resultsContainer"></div>
        </div>

        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const resultsContainer = document.getElementById('resultsContainer');
        const error = document.getElementById('error');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        if (!uploadArea || !fileInput || !loading || !results || !resultsContainer || !error) {
            console.error('–ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ DOM');
        }

        // –ö–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => fileInput.click());
        }

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        function handleFile(file) {
            if (!file.type.includes('pdf')) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                showError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            if (loading) loading.style.display = 'block';
            if (results) results.style.display = 'none';
            if (error) error.style.display = 'none';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (loading) loading.style.display = 'none';
                if (data.success) {
                    displayResults(data.results);
                } else {
                    showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞');
                }
            })
            .catch(err => {
                if (loading) loading.style.display = 'none';
                if (results) {
                    results.style.display = 'none';
                }
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + err.message);
            });
        }

        function displayResults(data) {
            if (!resultsContainer) {
                console.error('resultsContainer –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (!data || !Array.isArray(data)) {
                showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            data.forEach((pageResult, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-result';
                
                const pageHeader = document.createElement('div');
                pageHeader.className = 'page-header';
                pageHeader.innerHTML = `<h3>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageResult.page}</h3>`;
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'result-image';
                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + pageResult.image;
                img.alt = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageResult.page}`;
                imageDiv.appendChild(img);
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'stats';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ YOLO –¥–µ—Ç–µ–∫—Ü–∏–π
                const yoloStats = {};
                pageResult.yolo_detections.forEach(det => {
                    const className = det.class;
                    yoloStats[className] = (yoloStats[className] || 0) + 1;
                });
                
                let statsHTML = '<div class="stats-section"><h4>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:</h4><ul>';
                Object.entries(yoloStats).forEach(([className, count]) => {
                    statsHTML += `<li><strong>${className}</strong>: ${count}</li>`;
                });
                statsHTML += '</ul></div>';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ QR-–∫–æ–¥–æ–≤
                if (pageResult.qr_codes.length > 0) {
                    statsHTML += '<div class="stats-section"><h4>QR-–∫–æ–¥—ã:</h4><ul>';
                    pageResult.qr_codes.forEach((qr, idx) => {
                        statsHTML += `<li>QR-–∫–æ–¥ ${idx + 1}: ${qr.data.substring(0, 50)}${qr.data.length > 50 ? '...' : ''}</li>`;
                    });
                    statsHTML += '</ul></div>';
                }
                
                statsDiv.innerHTML = statsHTML;
                
                pageDiv.appendChild(pageHeader);
                pageDiv.appendChild(imageDiv);
                pageDiv.appendChild(statsDiv);
                
                resultsContainer.appendChild(pageDiv);
            });
            
            if (results) {
                results.style.display = 'block';
            }
        }

        function showError(message) {
            if (!error) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç error –Ω–µ –Ω–∞–π–¥–µ–Ω:', message);
                return;
            }
            error.textContent = message;
            error.style.display = 'block';
            setTimeout(() => {
                error.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>

